Khai thác các điều kiện tranh chấp khi tải tệp
Các framework hiện đại được trang bị tốt hơn để chống lại các loại tấn công này. Chúng thường không tải trực tiếp các tệp lên đích đến dự định trên hệ thống tệp. Thay vào đó, chúng thực hiện các biện pháp phòng ngừa như tải lên một thư mục tạm thời, được cách ly trước và ngẫu nhiên hóa tên để tránh ghi đè lên các tệp hiện có. Sau đó, chúng thực hiện xác thực tệp tạm thời này và chỉ chuyển nó đến đích khi được cho là an toàn.

Tuy nhiên, đôi khi các nhà phát triển tự triển khai quy trình xử lý tải lên tập tin một cách độc lập với bất kỳ framework nào. Điều này không chỉ khá phức tạp để thực hiện tốt mà còn có thể dẫn đến các điều kiện tranh chấp nguy hiểm, cho phép kẻ tấn công hoàn toàn vượt qua ngay cả các cơ chế xác thực mạnh mẽ nhất.

Khai thác lỗi tranh chấp khi tải lên tập tin - Phần tiếp theo
Ví dụ, một số trang web tải trực tiếp tệp lên hệ thống tệp chính rồi xóa nó đi nếu không vượt qua quá trình xác thực. Kiểu hành vi này thường thấy ở các trang web dựa vào phần mềm chống virus và các phần mềm tương tự để kiểm tra phần mềm độc hại. Quá trình này có thể chỉ mất vài mili giây, nhưng trong khoảng thời gian ngắn tệp tồn tại trên máy chủ, kẻ tấn công vẫn có khả năng thực thi nó.

Những lỗ hổng này thường rất khó phát hiện, khiến chúng trở nên khó khăn trong quá trình kiểm thử hộp đen trừ khi bạn tìm được cách làm rò rỉ mã nguồn liên quan.


Các điều kiện tranh chấp trong quá trình tải lên tệp dựa trên URL
Các tình trạng tranh chấp tài nguyên tương tự cũng có thể xảy ra trong các hàm cho phép bạn tải lên tệp bằng cách cung cấp URL. Trong trường hợp này, máy chủ phải tải tệp qua internet và tạo bản sao cục bộ trước khi có thể thực hiện bất kỳ thao tác xác thực nào.

Do tệp được tải bằng HTTP, các nhà phát triển không thể sử dụng các cơ chế tích hợp sẵn của khung phần mềm để xác thực tệp một cách an toàn. Thay vào đó, họ có thể tự tạo các quy trình riêng để lưu trữ và xác thực tệp tạm thời, điều này có thể không an toàn bằng.

Các vấn đề về xung đột truy cập đồng thời trong quá trình tải lên tập tin dựa trên URL - (Tiếp theo)
Ví dụ, nếu tệp được tải vào một thư mục tạm thời với tên ngẫu nhiên, về lý thuyết, kẻ tấn công sẽ không thể khai thác bất kỳ điều kiện tranh chấp nào. Nếu chúng không biết tên thư mục, chúng sẽ không thể yêu cầu tệp để kích hoạt quá trình thực thi. Mặt khác, nếu tên thư mục ngẫu nhiên được tạo bằng các hàm giả ngẫu nhiên như của PHP uniqid(), nó có thể bị tấn công bằng phương pháp vét cạn.

Để thực hiện các cuộc tấn công như vậy dễ dàng hơn, bạn có thể thử kéo dài thời gian xử lý tệp, từ đó kéo dài khoảng thời gian để tấn công vét cạn tên thư mục. Một cách để làm điều này là tải lên một tệp lớn hơn. Nếu tệp được xử lý theo từng phần, bạn có thể tận dụng điều này bằng cách tạo một tệp độc hại với phần mã độc ở đầu, theo sau là một lượng lớn các byte đệm tùy ý.

Khai thác lỗ hổng tải lên tập tin mà không cần thực thi mã từ xa
Trong các ví dụ chúng ta đã xem xét cho đến nay, chúng ta đã có thể tải lên các tập lệnh phía máy chủ để thực thi mã từ xa. Đây là hậu quả nghiêm trọng nhất của chức năng tải lên tập tin không an toàn, nhưng những lỗ hổng này vẫn có thể bị khai thác theo những cách khác.


Tải lên các tập lệnh phía máy khách độc hại
Mặc dù bạn có thể không thực thi được các tập lệnh trên máy chủ, nhưng bạn vẫn có thể tải lên các tập lệnh để thực hiện các cuộc tấn công phía máy khách. Ví dụ, nếu bạn có thể tải lên các tệp HTML hoặc hình ảnh SVG, bạn có thể sử dụng <script>các thẻ để tạo ra các payload XSS được lưu trữ.

Nếu tệp được tải lên xuất hiện trên một trang mà người dùng khác truy cập, trình duyệt của họ sẽ thực thi đoạn mã khi cố gắng hiển thị trang. Lưu ý rằng do các hạn chế của chính sách cùng nguồn gốc, các loại tấn công này chỉ hoạt động nếu tệp được tải lên được cung cấp từ cùng một nguồn gốc mà bạn tải lên.




Khai thác các lỗ hổng trong quá trình phân tích cú pháp các tệp đã tải lên
Nếu tệp tin được tải lên có vẻ được lưu trữ và phân phối một cách an toàn, biện pháp cuối cùng là thử khai thác các lỗ hổng cụ thể liên quan đến việc phân tích cú pháp hoặc xử lý các định dạng tệp khác nhau. Ví dụ, bạn biết rằng máy chủ phân tích cú pháp các tệp dựa trên XML, chẳng hạn như các tệp Microsoft Office .dochoặc .xlscác tệp khác, đây có thể là một hướng tấn công chèn mã XXE.





Tải lên tập tin bằng phương thức PUT
Cần lưu ý rằng một số máy chủ web có thể được cấu hình để hỗ trợ PUTcác yêu cầu này. Nếu không có các biện pháp phòng vệ thích hợp, điều này có thể cung cấp một phương tiện thay thế để tải lên các tệp độc hại, ngay cả khi chức năng tải lên không khả dụng thông qua giao diện web.

PUT /images/exploit.php HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-httpd-php
Content-Length: 49

<?php echo file_get_contents('/path/to/file'); ?>
Mẹo
Bạn có thể thử gửi OPTIONSyêu cầu đến các điểm cuối khác nhau để kiểm tra xem có điểm cuối nào hỗ trợ phương PUTthức đó hay không.





Cách phòng ngừa các lỗ hổng khi tải tập tin lên
Việc cho phép người dùng tải lên tập tin là điều phổ biến và không nhất thiết phải nguy hiểm miễn là bạn thực hiện các biện pháp phòng ngừa đúng đắn. Nhìn chung, cách hiệu quả nhất để bảo vệ trang web của bạn khỏi những lỗ hổng này là thực hiện tất cả các biện pháp sau:

Hãy kiểm tra phần mở rộng tệp so với danh sách trắng các phần mở rộng được cho phép thay vì danh sách đen các phần mở rộng bị cấm. Việc đoán xem bạn muốn cho phép phần mở rộng nào dễ hơn nhiều so với việc đoán xem kẻ tấn công có thể cố gắng tải lên phần mở rộng nào.
Hãy đảm bảo rằng tên tệp không chứa bất kỳ chuỗi con nào có thể được hiểu là thư mục hoặc chuỗi duyệt ( ../).
Đổi tên các tệp đã tải lên để tránh xung đột có thể dẫn đến việc ghi đè lên các tệp hiện có.
Không được tải các tệp lên hệ thống tệp vĩnh viễn của máy chủ cho đến khi chúng được xác thực đầy đủ.
Nên sử dụng một khuôn khổ đã được thiết lập sẵn để xử lý trước các tập tin tải lên thay vì cố gắng tự viết các cơ chế xác thực của riêng mình.





